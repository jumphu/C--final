# 项目调试日志与使用指南 (2025-12-07)

本文档记录了 2025 年 12 月 7 日对 `ProjectC` 进行的全面调试、重构及功能增强过程，并提供了最终的编译和使用指南。

## 1. 调试与修复日志 (Debugging Log)

我们在实现多场景物理模拟的过程中解决了以下关键问题：

### A. 构建系统与环境
*   **问题**：`cmake` 无法找到 EasyX 库，且项目缺少 `.lib` 文件。
*   **解决**：
    1.  在开发环境中定位到 `EasyXa.lib`。
    2.  创建 `scripts/compile_full.bat` 批处理脚本，自动配置 Visual Studio 2022 环境变量并链接库。
    3.  更新 `CMakeLists.txt` 以支持标准构建流程（作为备选）。

### B. 代码冲突与链接错误
*   **问题**：多个源文件（`main.cpp`, `menu.cpp`）包含 `main` 函数；多个按钮实现文件（`threebottums.cpp`, `spacebottum.cpp`, `choose.cpp`）定义了相同的全局函数（如 `drawButtons`），导致 `LNK2005` 重定义错误。
*   **解决**：
    1.  创建全新的入口文件 `src/main_graphical.cpp`。
    2.  在构建脚本中排除冲突文件（`main.cpp`, `menu.cpp`）。
    3.  重构 `src/spacebottum.cpp`，将函数重命名为 `...SceneModel...` 以区分于通用按钮逻辑，并将内部辅助函数设为 `static`。

### C. 运行时问题 (僵尸进程)
*   **问题**：点击窗口关闭按钮后，程序窗口消失但进程仍在后台运行。
*   **解决**：在主循环中添加 `IsWindow(GetHWnd())` 检测，并在 `main` 函数末尾调用 `ExitProcess(0)` 强制终止所有线程（包括 MCI 音频线程）。

### D. 物理引擎缺陷 (Slope Scene)
*   **问题 1**：斜坡场景中球体一开始就跳出屏幕或不可见。
    *   *原因*：`Renderer` 坐标原点默认在左下角，导致负坐标不可见；且物理世界与渲染坐标系不匹配。
    *   *修复*：修改 `Renderer.cpp`，将坐标原点移至屏幕**底部中央 (width/2, height-200)**。
*   **问题 2**：球体穿过斜坡并在内部跳动，或向错误方向反弹。
    *   *原因*：`PhysicalWorld::resolveCollision` 对 `Slope` 使用了通用的“质心连线”法向量计算，导致反弹方向错误；且缺乏针对静态物体的“静止接触 (Resting Contact)”处理。
    *   *修复*：在 `resolveCollision` 中增加对 `Slope` 的特殊处理，计算正确的法向量（垂直于斜面），并引入速度阈值以消除微小抖动。同时修复 `separateOverlappingShapes` 以支持 Slope 的位置修正。
*   **问题 3**：球体初始位置不贴合。
    *   *修复*：使用几何公式精确计算球心坐标，使其完美相切于斜坡表面。

### E. 界面优化
*   **问题**：速度文字显示不清，位置遮挡物体。
*   **解决**：在 `adapter.cpp` 中实现自适应字体颜色（深色物体用白色文字），并将文字绘制坐标调整为居中。

---

## 2. 编译指南 (Build Instructions)

本项目已配置为一键编译。

### 前置条件
*   Windows 10/11
*   Visual Studio 2022 (Community 或 Enterprise) 安装了 C++ 桌面开发组件。

### 编译步骤
1.  双击运行项目根目录下的脚本：
    ```cmd
    scripts\compile_full.bat
    ```
2.  脚本会自动：
    *   加载 VS2022 编译器环境 (`cl.exe`)。
    *   编译 `src/` 下的相关 C++ 文件。
    *   链接 `lib/EasyXa.lib` 和系统库。
    *   生成可执行文件 `bin/ProjectC_final.exe`。

### 注意事项
*   **文件锁定**：如果之前的程序正在运行，编译会失败（`LNK1104`）。请务必先关闭正在运行的演示窗口。
*   **音频文件**：程序运行时需要加载背景音乐。请确保 **`bin/` 目录下存在名为 `bgm.mp3` 的文件**。如果缺失，程序仍能运行，但在控制台会输出 MCI 错误。

---

## 3. 使用说明 (User Manual)

运行 `bin\ProjectC_final.exe` 启动程序。

### 场景选择
界面右侧有三个按钮，对应三个核心场景。您也可以使用键盘快捷键切换：

1.  **Slope Scene (按键 '1')**:
    *   演示小球从左侧斜坡顶端滚落。展示了斜坡碰撞检测和重力分量模拟。
2.  **Ball Collision (按键 '2')**:
    *   演示两个小球在平地上的对撞。展示了动量守恒和弹性碰撞。
3.  **Stacking Demo (按键 '3')**:
    *   演示方块的堆叠。展示了静摩擦力和支撑力逻辑。
4.  **Slope Left (按键 '4')**:
    *   演示小球从右侧斜坡滚向左侧。

### 模拟控制
界面下方有三个控制按钮：
*   **Start**: 开始/继续模拟。
*   **Pause**: 暂停模拟（画面冻结，可进行观察）。
*   **Stop**: 停止并重置当前场景。

### 交互操作
*   **鼠标拖拽**：在任意场景中，您可以**左键点击并拖拽**任何物体（球或方块）来改变其位置或扰动物理状态。
*   **速度显示**：动态物体中心会实时显示当前速度值 (`v=...`)。

---
*文档生成时间：2025-12-07*
